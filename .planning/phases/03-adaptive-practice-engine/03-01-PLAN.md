---
phase: 03-adaptive-practice-engine
plan: "01"
type: tdd
wave: 1
depends_on: []
files_modified:
  - adaptive-tutor/src/lib/algorithms/sm2.ts
  - adaptive-tutor/src/lib/algorithms/__tests__/sm2.test.ts
autonomous: true
requirements:
  - LEARN-07

must_haves:
  truths:
    - "updateSM2 resets interval to 1 and repetitionCount to 0 on quality < 3"
    - "updateSM2 increases interval correctly for quality >= 3 (1 → 1 → 3 → interval*easeFactor)"
    - "easeFactor is always >= 1.3 regardless of incorrect streaks"
    - "getNextDueDate returns a Date object set to today + interval days"
    - "userAnswerToQuality maps fast+correct to 5, slow+correct to 4, incorrect to 1"
  artifacts:
    - path: "adaptive-tutor/src/lib/algorithms/sm2.ts"
      provides: "SM-2 spaced repetition algorithm"
      exports: ["SM2State", "updateSM2", "getNextDueDate", "userAnswerToQuality"]
    - path: "adaptive-tutor/src/lib/algorithms/__tests__/sm2.test.ts"
      provides: "Unit tests for SM-2 algorithm"
      contains: "describe.*sm2"
  key_links:
    - from: "adaptive-tutor/src/lib/algorithms/sm2.ts"
      to: "adaptive-tutor/src/app/api/study-plans/[id]/attempt/route.ts"
      via: "imported updateSM2 and getNextDueDate in attempt route (Plan 03-04)"
      pattern: "updateSM2|getNextDueDate"
---

<objective>
Implement the SM-2 spaced repetition algorithm as a pure TypeScript module with full unit test coverage.

Purpose: SM-2 drives the nextDue scheduling that makes practice adaptive — it is the core scheduling engine that decides when each concept should be reviewed. Getting it correct is critical because every proficiency update and session composition depends on it.
Output: src/lib/algorithms/sm2.ts (pure functions, no side effects) + passing unit tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@adaptive-tutor/phase3tech/PHASE3-TECHNICAL-SPEC.md
@adaptive-tutor/src/lib/types.ts
</context>

<feature>
  <name>SM-2 Spaced Repetition Algorithm</name>
  <files>
    adaptive-tutor/src/lib/algorithms/sm2.ts,
    adaptive-tutor/src/lib/algorithms/__tests__/sm2.test.ts
  </files>
  <behavior>
    Implement the exact SM-2 algorithm from PHASE3-TECHNICAL-SPEC.md verbatim:

    Interface:
      SM2State { easeFactor: number, interval: number, repetitionCount: number }

    updateSM2(state: SM2State, quality: number): SM2State
    - If quality < 3: reset repetitionCount=0, interval=1 (easeFactor still updates)
    - If quality >= 3:
      - repetitionCount++
      - If repetitionCount === 1: interval = 1
      - If repetitionCount === 2: interval = 3
      - If repetitionCount >= 3: interval = Math.round(interval * easeFactor)
    - Always: easeFactor = Math.max(1.3, easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02)))
    - Returns new SM2State (do NOT mutate input)

    getNextDueDate(interval: number): Date
    - Returns new Date() with date.setDate(date.getDate() + interval)

    userAnswerToQuality(isCorrect: boolean, timeTaken: number): number
    - If !isCorrect: return 1
    - If isCorrect and timeTaken < 10000ms: return 5
    - If isCorrect and timeTaken < 30000ms: return 4
    - If isCorrect and timeTaken >= 30000ms: return 3

    Test cases (RED phase — write these first):
    - updateSM2({ easeFactor: 2.5, interval: 1, repetitionCount: 0 }, 0) → repetitionCount=0, interval=1
    - updateSM2({ easeFactor: 2.5, interval: 1, repetitionCount: 0 }, 5) → repetitionCount=1, interval=1
    - updateSM2({ easeFactor: 2.5, interval: 1, repetitionCount: 1 }, 5) → repetitionCount=2, interval=3
    - updateSM2({ easeFactor: 2.5, interval: 3, repetitionCount: 2 }, 5) → repetitionCount=3, interval=Math.round(3*2.6)=8
    - easeFactor floor: multiple quality=0 answers never push easeFactor below 1.3
    - userAnswerToQuality(false, 5000) → 1
    - userAnswerToQuality(true, 5000) → 5 (under 10s)
    - userAnswerToQuality(true, 15000) → 4 (10-30s)
    - userAnswerToQuality(true, 35000) → 3 (over 30s)
    - getNextDueDate(1) → Date approximately 1 day from now
  </behavior>
  <implementation>
    RED: Write sm2.test.ts first with all test cases above. Run — all must FAIL.
    GREEN: Write sm2.ts with exact algorithm from spec. Run — all must PASS.
    REFACTOR: Ensure types exported, no mutations, JSDoc comments on each function.

    Use vitest (check adaptive-tutor/package.json for test runner). If no test framework configured, use Jest.
    Test file location: adaptive-tutor/src/lib/algorithms/__tests__/sm2.test.ts
    Run tests from: adaptive-tutor/ directory with npm test or npx vitest run

    Do NOT deviate from the spec algorithm even if alternative implementations seem cleaner — the attempt route (Plan 03-04) will import this verbatim.
  </implementation>
</feature>

<verification>
  <automated>cd /Users/rykkim/Documents/githublocal/yale-agentic-ai-hackathon/adaptive-tutor && npx vitest run src/lib/algorithms/__tests__/sm2.test.ts 2>&1 || npm test -- --testPathPattern=sm2 2>&1</automated>
  <manual>Verify all test cases listed in the behavior section pass. Verify easeFactor never drops below 1.3 in the incorrect streak test.</manual>
</verification>

<success_criteria>
- sm2.ts exists and exports SM2State interface, updateSM2, getNextDueDate, userAnswerToQuality
- All unit tests pass (RED → GREEN cycle completed)
- No TypeScript type errors (run tsc --noEmit from adaptive-tutor/)
- Algorithm matches PHASE3-TECHNICAL-SPEC.md verbatim (no variations)
</success_criteria>

<output>
After completion, create `.planning/phases/03-adaptive-practice-engine/03-01-SUMMARY.md`
</output>
