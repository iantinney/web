---
phase: 01-data-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - adaptive-tutor/src/lib/prisma.ts
  - adaptive-tutor/src/lib/db.ts
  - adaptive-tutor/prisma/schema.prisma
  - adaptive-tutor/prisma/seed.ts
autonomous: true

must_haves:
  truths:
    - "Prisma client connects to SQLite and can execute queries"
    - "`npx prisma db push` creates all tables in dev.db without errors"
    - "`npm run seed` creates demo user in SQLite database"
    - "Prisma singleton prevents multiple client instances during Next.js hot reload"
  artifacts:
    - path: "adaptive-tutor/src/lib/prisma.ts"
      provides: "Prisma client singleton for Next.js"
      contains: "globalForPrisma"
    - path: "adaptive-tutor/src/lib/db.ts"
      provides: "Database access layer using Prisma instead of JSON files"
      contains: "prisma"
    - path: "adaptive-tutor/prisma/seed.ts"
      provides: "Seed script that creates demo user and optional demo data via Prisma"
      contains: "PrismaClient"
    - path: "adaptive-tutor/prisma/schema.prisma"
      provides: "Verified Prisma schema with all models for P0 requirements"
      contains: "model StudyPlan"
  key_links:
    - from: "adaptive-tutor/src/lib/db.ts"
      to: "adaptive-tutor/src/lib/prisma.ts"
      via: "import { prisma }"
      pattern: "import.*prisma.*from.*@/lib/prisma"
    - from: "adaptive-tutor/prisma/seed.ts"
      to: "adaptive-tutor/prisma/schema.prisma"
      via: "PrismaClient generated from schema"
      pattern: "PrismaClient"
---

<objective>
Migrate the persistence layer from JSON files to Prisma + SQLite. Create the Prisma client singleton, rewrite the db.ts abstraction to use Prisma queries, update the seed script, and verify the schema is correct for all P0 requirements.

Purpose: The JSON file backend is fragile (no transactions, no indexes, O(n) scans, concurrent write corruption). Prisma + SQLite was the decided tech stack. This plan establishes the real database foundation that all later phases depend on.

Output: Working Prisma + SQLite backend with db.ts providing the same API surface to minimize churn in existing route files.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@.planning/research/STACK.md

Key existing files to reference:
@adaptive-tutor/prisma/schema.prisma
@adaptive-tutor/src/lib/db.ts
@adaptive-tutor/src/lib/types.ts
@adaptive-tutor/src/lib/config.ts
@adaptive-tutor/prisma/seed.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Prisma client singleton and migrate db.ts to Prisma</name>
  <files>
    adaptive-tutor/src/lib/prisma.ts
    adaptive-tutor/src/lib/db.ts
    adaptive-tutor/prisma/schema.prisma
  </files>
  <action>
**Step 1: Verify and finalize Prisma schema.**

The existing `prisma/schema.prisma` is already well-defined. Verify it covers all models: User, StudyPlan, ConceptNode, ConceptEdge, Question, AttemptRecord, SessionRecord, ChatThread, ChatMessage. The current schema looks correct. No changes needed unless a gap is found during review.

Run `npx prisma db push` from the `adaptive-tutor/` directory to create the SQLite database and generate the Prisma client.

**Step 2: Create Prisma client singleton.**

Create `src/lib/prisma.ts` with the Next.js hot-reload-safe singleton pattern:

```typescript
import { PrismaClient } from "@prisma/client";

const globalForPrisma = globalThis as unknown as { prisma: PrismaClient };

export const prisma = globalForPrisma.prisma ?? new PrismaClient();

if (process.env.NODE_ENV !== "production") globalForPrisma.prisma = prisma;
```

This prevents multiple PrismaClient instances during Next.js dev mode hot reload (documented pitfall from research/STACK.md).

**Step 3: Rewrite `src/lib/db.ts` to use Prisma.**

Replace the JSON file read/write functions with Prisma query wrappers. The goal is to keep the same exported function signatures (`findMany`, `findUnique`, `findFirst`, `create`, `update`, `remove`, `removeMany`) so existing API routes require minimal changes. However, the implementations should now use Prisma.

The key change: instead of `readTable<T>(tableName)` with JSON files, use `prisma[modelName].findMany()` etc.

Create a mapping from table string names to Prisma model delegates:
- "users" -> prisma.user
- "studyPlans" -> prisma.studyPlan
- "conceptNodes" -> prisma.conceptNode
- "conceptEdges" -> prisma.conceptEdge
- "questions" -> prisma.question
- "attemptRecords" -> prisma.attemptRecord
- "sessionRecords" -> prisma.sessionRecord
- "chatThreads" -> prisma.chatThread
- "chatMessages" -> prisma.chatMessage

IMPORTANT: The current generic `findMany<T>(table: string, filter?: Partial<T>)` pattern with string table names is an anti-pattern with Prisma. Instead of keeping the generic string-based API, refactor db.ts to export Prisma-native helper functions that are type-safe. The simplest approach: re-export `prisma` directly and let API routes call `prisma.studyPlan.findMany(...)` etc. But to minimize churn, provide backward-compatible wrapper functions that map string table names to Prisma model calls.

Remove the JSON file I/O code entirely (fs imports, readTable, writeTable, ensureDataDir, filePath). Remove the auto-seed block at the bottom (`if (typeof window === "undefined") { seed(); }`).

Also remove the `seed()` function from db.ts -- seeding will be handled by `prisma/seed.ts` only.

**What NOT to do:**
- Do NOT keep any JSON file references in db.ts. This is a clean migration.
- Do NOT add `data/` directory operations. The data/ folder is obsolete.
- Do NOT change the Prisma schema unless a genuine gap is found. The schema is already well-designed.
  </action>
  <verify>
Run from `adaptive-tutor/` directory:
1. `npx prisma db push` -- should complete without errors, creating dev.db
2. `npx prisma generate` -- should generate client without errors
3. `npx tsx -e "import { prisma } from './src/lib/prisma'; prisma.user.count().then(c => console.log('User count:', c)).catch(e => console.error(e)).finally(() => prisma.$disconnect())"` -- should print "User count: 0" (empty DB)
4. TypeScript compilation: `npx tsc --noEmit` should pass for the modified files (or at least not have NEW errors related to db.ts/prisma.ts)
  </verify>
  <done>
Prisma client singleton exists at src/lib/prisma.ts. db.ts uses Prisma instead of JSON files. All JSON file I/O code is removed. `npx prisma db push` creates SQLite database successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite seed script and verify database initialization</name>
  <files>
    adaptive-tutor/prisma/seed.ts
    adaptive-tutor/package.json
  </files>
  <action>
**Step 1: Rewrite `prisma/seed.ts` to use PrismaClient.**

Replace the JSON file seed logic with Prisma operations:

```typescript
import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

async function main() {
  console.log("Seeding database...\n");

  // 1. Create demo user (upsert to be idempotent)
  const user = await prisma.user.upsert({
    where: { id: "demo-user" },
    update: {},
    create: {
      id: "demo-user",
      displayName: "Learner",
    },
  });
  console.log("  Created demo user:", user.id);

  // 2. Optionally create a demo study plan (empty, for testing)
  const existingPlans = await prisma.studyPlan.count({
    where: { userId: "demo-user" },
  });
  if (existingPlans === 0) {
    await prisma.studyPlan.create({
      data: {
        userId: "demo-user",
        title: "Demo Study Plan",
        description: "A sample study plan for testing",
        sourceText: "Introduction to Linear Algebra: vectors, matrices, transformations",
        status: "active",
      },
    });
    console.log("  Created demo study plan");
  }

  console.log("\nSeed complete!");
}

main()
  .catch((e) => {
    console.error("Seed error:", e);
    process.exit(1);
  })
  .finally(() => prisma.$disconnect());
```

**Step 2: Update package.json seed script and add Prisma seed config.**

The existing seed script is `"seed": "npx tsx prisma/seed.ts"`. Keep this but also add the Prisma seed configuration to package.json so `npx prisma db seed` also works:

Add to package.json:
```json
"prisma": {
  "seed": "npx tsx prisma/seed.ts"
}
```

**Step 3: Run the seed and verify.**

Execute `npm run seed` from the `adaptive-tutor/` directory. Verify the demo user and demo study plan exist in SQLite by querying with Prisma.

**What NOT to do:**
- Do NOT create elaborate demo data (graph nodes, questions etc). That's Phase 2/3 work.
- Do NOT leave any JSON file references in seed.ts.
  </action>
  <verify>
Run from `adaptive-tutor/` directory:
1. `npm run seed` -- should print seed messages without errors
2. `npx tsx -e "import { PrismaClient } from '@prisma/client'; const p = new PrismaClient(); p.user.findUnique({ where: { id: 'demo-user' } }).then(u => console.log('User:', u)).finally(() => p.\$disconnect())"` -- should print the demo user
3. `npx tsx -e "import { PrismaClient } from '@prisma/client'; const p = new PrismaClient(); p.studyPlan.findMany({ where: { userId: 'demo-user' } }).then(plans => console.log('Plans:', plans.length)).finally(() => p.\$disconnect())"` -- should print "Plans: 1"
4. Run `npm run seed` a second time -- should be idempotent (no duplicate user error)
  </verify>
  <done>
`npm run seed` creates demo user and demo study plan in SQLite. Running seed twice is safe (idempotent via upsert). Package.json has Prisma seed config. No JSON file references remain in seed.ts.
  </done>
</task>

</tasks>

<verification>
After both tasks are complete:
1. `npx prisma db push` creates the database without errors
2. `npm run seed` populates demo data
3. `src/lib/prisma.ts` exports a singleton PrismaClient
4. `src/lib/db.ts` no longer imports `fs` or references JSON files
5. The `data/` directory is no longer needed (but don't delete it -- it's gitignored)
6. `npx tsc --noEmit` should not introduce new type errors in db.ts
</verification>

<success_criteria>
- Prisma + SQLite replaces JSON file backend entirely in db.ts
- Seed script uses PrismaClient, creates demo user + demo study plan
- Prisma client singleton prevents hot-reload connection leaks
- Schema matches all 9 models from requirements (User, StudyPlan, ConceptNode, ConceptEdge, Question, AttemptRecord, SessionRecord, ChatThread, ChatMessage)
- No migration needed after this point -- schema is locked for later phases
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-foundation/01-01-SUMMARY.md`
</output>
