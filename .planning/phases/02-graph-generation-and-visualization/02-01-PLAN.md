---
phase: "02"
plan: "02-01"
type: execute
wave: 1
depends_on: []
files_modified:
  - "adaptive-tutor/src/lib/minimax.ts"
  - "adaptive-tutor/src/lib/schemas.ts"
  - "adaptive-tutor/src/lib/prompts/index.ts"
  - "adaptive-tutor/src/app/api/study-plans/[id]/generate-graph/route.ts"
  - "adaptive-tutor/prisma/schema.prisma"
autonomous: true
must_haves:
  truths:
    - "MiniMax API call succeeds with correct model name and returns structured JSON"
    - "Graph generation endpoint calls MiniMax, parses JSON, validates with Zod, breaks cycles, persists nodes+edges to DB"
    - "Retry logic handles malformed JSON on first attempt"
    - "edgeType field distinguishes prerequisite from helpful edges"
  artifacts:
    - path: "adaptive-tutor/src/lib/minimax.ts"
      provides: "Correct MiniMax model constants"
      contains: "MiniMax-Text-01"
    - path: "adaptive-tutor/src/app/api/study-plans/[id]/generate-graph/route.ts"
      provides: "Live MiniMax graph generation replacing demo stub"
      contains: "generateText"
    - path: "adaptive-tutor/src/lib/schemas.ts"
      provides: "Updated Zod schemas with edgeType and min(3) concepts"
      contains: "edgeType"
  key_links:
    - from: "generate-graph/route.ts"
      to: "minimax.ts"
      via: "import and call generateText with minimax provider"
      pattern: "generateText.*minimax"
    - from: "generate-graph/route.ts"
      to: "schemas.ts"
      via: "parseLLMJson + LLMConceptGraphSchema.safeParse"
      pattern: "parseLLMJson.*LLMConceptGraphSchema"
---

# Phase 02-01: MiniMax Integration & Graph Generation Pipeline

## Objective

Wire the existing graph generation endpoint to the live MiniMax API. Replace the `generateDemoGraph` stub with a real MiniMax `generateText` call, update model names, enhance Zod schemas with `edgeType` support, improve the graph generation prompt, and add retry logic for malformed JSON. Add `edgeType` column to Prisma schema.

Purpose: This is the foundational LLM integration -- nothing else in Phase 02 works until MiniMax returns a valid concept graph and it persists to the database.

Output: A working `POST /api/study-plans/[id]/generate-graph` endpoint that calls MiniMax, parses the response, validates the DAG, and persists nodes + edges.

## Success Criteria

- [ ] `MINIMAX_MODEL_STRONG` and `MINIMAX_MODEL_FAST` updated to working model names in `minimax.ts`
- [ ] `POST /api/study-plans/[id]/generate-graph` calls MiniMax with `generateText`, temperature 0.3
- [ ] Response parsed with `parseLLMJson`, validated with `LLMConceptGraphSchema`
- [ ] On JSON parse failure, single retry with lower temperature (0.1) and explicit error context
- [ ] `LLMConceptGraphSchema` requires `min(3)` concepts (not `min(1)`)
- [ ] `LLMConceptEdgeSchema` includes optional `edgeType: "prerequisite" | "helpful"` defaulting to `"prerequisite"`
- [ ] `ConceptEdge` Prisma model has `edgeType String @default("prerequisite")` column
- [ ] `prisma db push` runs without error
- [ ] Cycle detection via `validateDAG` + `breakCycles` still works (no regression)
- [ ] `breakCycles` heuristic improved to prefer removing edges where fromTier > toTier
- [ ] API response includes `removedEdges` array listing any edges removed for cycle breaking
- [ ] Graph generation prompt includes edgeType in schema, "Do not include markdown code fences" instruction
- [ ] `generateDemoGraph` stub function removed from route file

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-graph-generation-and-visualization/02-RESEARCH.md
@adaptive-tutor/src/lib/minimax.ts
@adaptive-tutor/src/lib/schemas.ts
@adaptive-tutor/src/lib/prompts/index.ts
@adaptive-tutor/src/app/api/study-plans/[id]/generate-graph/route.ts
@adaptive-tutor/src/lib/algorithms/graphValidator.ts
@adaptive-tutor/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MiniMax model names, Prisma schema, and Zod schemas</name>
  <files>
    adaptive-tutor/src/lib/minimax.ts
    adaptive-tutor/prisma/schema.prisma
    adaptive-tutor/src/lib/schemas.ts
  </files>
  <action>
  1. In `minimax.ts`: Keep `MINIMAX_MODEL_STRONG = "MiniMax-Text-01"` and `MINIMAX_MODEL_FAST = "MiniMax-Text-01"` as-is initially (research indicates Text-01 may still work; M2 series are listed in docs but backward compat is unconfirmed). Add a comment noting M2.5 as fallback. The executor should test with Text-01 first; if it 404s, switch to `"MiniMax-M2.5"` / `"MiniMax-M2.5-highspeed"`.

  2. In `prisma/schema.prisma`: Add `edgeType String @default("prerequisite")` field to the `ConceptEdge` model, right after `studyPlanId`. Then run `npx prisma db push` from the `adaptive-tutor` directory.

  3. In `schemas.ts`:
     - Update `LLMConceptEdgeSchema` to include `edgeType: z.enum(["prerequisite", "helpful"]).optional().default("prerequisite")`
     - Update `LLMConceptGraphSchema` to use `.min(3)` on the concepts array instead of `.min(1)` (meaningful graphs need at least 3 concepts)

  WHY edgeType: The CONTEXT.md decision says edges are "hard prerequisites + helpful context." Distinguishing them enables different visual rendering in the Graph tab (solid vs dashed).
  </action>
  <verify>
  - `npx prisma db push` succeeds without error
  - `npx tsc --noEmit` from adaptive-tutor directory passes (no type errors from schema changes)
  </verify>
  <done>Prisma schema has edgeType column, Zod schemas updated, model names ready for testing</done>
</task>

<task type="auto">
  <name>Task 2: Wire MiniMax graph generation + improve cycle breaking + update prompt</name>
  <files>
    adaptive-tutor/src/app/api/study-plans/[id]/generate-graph/route.ts
    adaptive-tutor/src/lib/prompts/index.ts
    adaptive-tutor/src/lib/algorithms/graphValidator.ts
  </files>
  <action>
  1. In `prompts/index.ts`: Update `generateConceptGraphPrompt` to:
     - Add `"edgeType": "prerequisite" | "helpful"` to the edge schema in the prompt's JSON example
     - Add rule: "The FROM concept must be logically learned before TO"
     - Add rule: "Do not include markdown code fences or any text outside the JSON"
     - Update the few-shot example edges to include `"edgeType": "prerequisite"`
     - Keep all other rules unchanged

  2. In `graphValidator.ts`: Improve `breakCycles` to use the `getNodeTier` callback:
     - When finding an edge to remove among cyclic nodes, prefer edges where `getNodeTier(e.from) > getNodeTier(e.to)` (reversed difficulty = likely erroneous)
     - If no such edge exists, fall back to removing the first cyclic edge (current behavior)
     - Add console.log for each removed edge: `"Cycle break: removed edge [fromName] -> [toName]"`

  3. In `generate-graph/route.ts`: Replace `generateDemoGraph` with live MiniMax call:
     - Remove the entire `generateDemoGraph` function
     - Import `{ minimax, generateText, MINIMAX_MODEL_STRONG }` from `@/lib/minimax`
     - Import `{ generateConceptGraphPrompt }` from `@/lib/prompts`
     - Import `{ parseLLMJson }` from `@/lib/schemas`
     - Replace `const raw = generateDemoGraph(...)` with:
       ```
       const { text } = await generateText({
         model: minimax(MINIMAX_MODEL_STRONG),
         prompt: generateConceptGraphPrompt(plan.sourceText),
         temperature: 0.3,
         maxTokens: 4000,
       });
       let raw: unknown;
       try {
         raw = parseLLMJson(text);
       } catch {
         // Retry once with lower temperature and explicit error context
         const retry = await generateText({
           model: minimax(MINIMAX_MODEL_STRONG),
           prompt: generateConceptGraphPrompt(plan.sourceText) +
             '\n\nIMPORTANT: Your previous response was not valid JSON. Output ONLY the JSON object, nothing else.',
           temperature: 0.1,
           maxTokens: 4000,
         });
         raw = parseLLMJson(retry.text);
       }
       ```
     - When creating ConceptEdge records, include `edgeType` from parsed edge data (default "prerequisite")
     - Track removed edges during cycle breaking: build a `removedEdges` array of `{from: name, to: name}` objects
     - Include `removedEdges` in the API response JSON
     - Add source text length validation: if `plan.sourceText.trim().length < 50`, return 400 with message asking for more detail

  WHY generateText not generateObject: MiniMax's OpenAI-compatible endpoint does not reliably support `response_format: json_schema`. The pattern is: prompt engineering + lenient JSON parsing + retry. This is the approach validated in research.

  WHY temperature 0.3: Lower temperature dramatically improves JSON structure reliability from LLMs. The retry uses 0.1 for maximum reliability.
  </action>
  <verify>
  - `npx tsc --noEmit` passes
  - Manually test: `curl -X POST http://localhost:3000/api/study-plans/PLAN_ID/generate-graph` returns graph JSON with nodes, edges, nodeCount, edgeCount, removedEdges (requires running dev server with MINIMAX_API_KEY set and a study plan with sourceText in DB)
  - If MiniMax API key not available for live testing, verify code compiles and the demo graph stub is fully removed
  </verify>
  <done>Graph generation endpoint calls MiniMax live, parses JSON with retry, validates DAG, breaks cycles with tier heuristic, persists to DB, returns structured response with removedEdges</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd adaptive-tutor && npx tsc --noEmit`
2. Prisma schema valid: `cd adaptive-tutor && npx prisma db push`
3. If MINIMAX_API_KEY is set: `npm run dev` then test generate-graph endpoint with a real study plan
4. Verify `generateDemoGraph` function is completely removed from the route file
5. Verify edgeType flows through: prompt -> LLM response -> Zod parse -> DB create
</verification>

<success_criteria>
- MiniMax graph generation works end-to-end (or compiles correctly if API key unavailable)
- Demo graph stub is removed
- Cycle breaking uses tier heuristic
- edgeType persists through the full pipeline
- Retry logic handles malformed JSON gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/02-graph-generation-and-visualization/02-01-SUMMARY.md`
</output>
