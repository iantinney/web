---
phase: "02"
plan: "02-03"
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - "adaptive-tutor/src/app/(tabs)/graph/page.tsx"
  - "adaptive-tutor/src/components/graph/ConceptNode.tsx"
  - "adaptive-tutor/src/components/graph/NodeDetailPanel.tsx"
autonomous: true
must_haves:
  truths:
    - "React Flow renders concept graph with proficiency-colored nodes"
    - "Custom node component is wrapped in React.memo for performance"
    - "Hard prerequisite edges render as solid lines, helpful context edges render as dashed lines"
    - "Clicking a node opens a detail panel with concept metadata, proficiency, prerequisites, and dependents"
    - "Detail panel has a Practice CTA and Edit mode for concept details"
  artifacts:
    - path: "adaptive-tutor/src/components/graph/ConceptNode.tsx"
      provides: "Extracted React.memo-wrapped custom node component"
      contains: "React.memo"
    - path: "adaptive-tutor/src/components/graph/NodeDetailPanel.tsx"
      provides: "Slide-in detail panel for concept nodes"
      contains: "NodeDetailPanel"
    - path: "adaptive-tutor/src/app/(tabs)/graph/page.tsx"
      provides: "Graph page with onNodeClick, detail panel, edge type rendering"
      contains: "onNodeClick"
  key_links:
    - from: "graph/page.tsx"
      to: "ConceptNode.tsx"
      via: "nodeTypes registration"
      pattern: "nodeTypes.*concept.*ConceptNode"
    - from: "graph/page.tsx"
      to: "NodeDetailPanel.tsx"
      via: "conditional render on selectedConcept state"
      pattern: "selectedConcept.*NodeDetailPanel"
    - from: "NodeDetailPanel.tsx"
      to: "store.ts"
      via: "setActiveTab('learn') for Practice CTA"
      pattern: "setActiveTab"
---

# Phase 02-03: React Flow Visualization, Node Detail Panel & Edge Types

## Objective

Extract the custom node component into a separate file with React.memo, add onNodeClick to open a detail panel with full concept metadata, implement edge type visual differentiation (solid vs dashed), and build the node detail panel with proficiency metrics, prerequisites/dependents list, Practice CTA, and edit mode.

Purpose: The graph visualization is the "hero" view of the application. Users need to see their concept DAG with meaningful proficiency colors, click nodes for details, and navigate to practice sessions from the graph.

Output: A polished, performant React Flow graph with interactive nodes and a detail panel.

## Success Criteria

- [ ] `ConceptNodeComponent` extracted to `src/components/graph/ConceptNode.tsx` and wrapped in `React.memo`
- [ ] `nodeTypes` object defined outside any component (not recreated on render)
- [ ] Hard prerequisite edges: solid line, strokeWidth 2, `var(--border)` color
- [ ] Helpful context edges: dashed line (`strokeDasharray: "5,5"`), strokeWidth 1, opacity 0.5
- [ ] Edge `animated: true` removed (performance; visual noise)
- [ ] Clicking a node sets `selectedConcept` state and opens `NodeDetailPanel`
- [ ] NodeDetailPanel shows: name, description, key terms (parsed from JSON), difficulty tier badge
- [ ] NodeDetailPanel shows: proficiency score (as percentage + color bar), attempt count, last practiced date
- [ ] NodeDetailPanel shows: prerequisite concepts list (names, clickable to select that node)
- [ ] NodeDetailPanel shows: dependent concepts list (names, clickable to select that node)
- [ ] NodeDetailPanel has "Practice this concept" button that sets `activeTab` to "learn" (and stores `targetConceptId` in Zustand for Phase 03)
- [ ] NodeDetailPanel has edit mode toggle: inline editing of name, description, key terms
- [ ] Edit saves via `PATCH /api/study-plans/[id]/concepts/[conceptId]` (new endpoint) and updates Zustand store optimistically
- [ ] Panel closes on Escape key or close button (not on background click)
- [ ] Panel positioned as right-side overlay (`absolute right-0 top-0 h-full w-80`)

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-graph-generation-and-visualization/02-RESEARCH.md
@.planning/phases/02-graph-generation-and-visualization/02-01-SUMMARY.md
@adaptive-tutor/src/app/(tabs)/graph/page.tsx
@adaptive-tutor/src/lib/store.ts
@adaptive-tutor/src/lib/types.ts
@adaptive-tutor/src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract ConceptNode component + edge type rendering + onNodeClick</name>
  <files>
    adaptive-tutor/src/components/graph/ConceptNode.tsx
    adaptive-tutor/src/app/(tabs)/graph/page.tsx
  </files>
  <action>
  1. Create `src/components/graph/ConceptNode.tsx`:
     - Move the `ConceptNodeComponent` function from `graph/page.tsx` into this new file
     - Wrap with `React.memo`: `export const ConceptNode = React.memo(ConceptNodeComponent)`
     - Keep the same colorMap, Handle components, and proficiency display
     - Add a subtle hover effect (e.g., `boxShadow` on hover via inline style or className)
     - Export both the component and the `nodeTypes` object: `export const nodeTypes = { concept: ConceptNode }`

  2. Update `graph/page.tsx`:
     - Remove the inline `ConceptNodeComponent` and `nodeTypes` definition
     - Import `{ nodeTypes }` from `@/components/graph/ConceptNode`
     - Add `selectedConcept` state: `const [selectedConcept, setSelectedConcept] = useState<ConceptNode | null>(null)`
     - Add `onNodeClick` callback:
       ```
       const onNodeClick = useCallback((_event: React.MouseEvent, node: Node) => {
         const concept = conceptNodes.find(c => c.id === node.id);
         setSelectedConcept(concept ?? null);
       }, [conceptNodes]);
       ```
     - Pass `onNodeClick` to `<ReactFlow>`
     - Update edge rendering in `flowEdges` useMemo: read `edgeType` from edge data. For the existing `conceptEdges` array, check if each edge has an `edgeType` property (it may not exist for edges created before schema update -- default to "prerequisite").
       - prerequisite: `{ type: "smoothstep", style: { stroke: "var(--border)", strokeWidth: 2 } }`
       - helpful: `{ type: "smoothstep", style: { stroke: "var(--border)", strokeWidth: 1, strokeDasharray: "5,5", opacity: 0.5 } }`
       - Remove `animated: true` from all edges
     - Conditionally render `<NodeDetailPanel>` when `selectedConcept` is not null (import from next task's file -- add placeholder import for now)
     - Add Escape key handler (useEffect with keydown listener) to close panel

  NOTE on edgeType in conceptEdges: The Zustand store's `conceptEdges` array uses the `ConceptEdge` type from `types.ts`, which currently doesn't have `edgeType`. Update `ConceptEdge` interface in `types.ts` to add `edgeType?: string` (optional for backward compat).
  </action>
  <verify>
  - `npx tsc --noEmit` passes (may have import error for NodeDetailPanel -- acceptable until Task 2)
  - ConceptNode.tsx exists and exports React.memo-wrapped component
  - `graph/page.tsx` no longer contains inline ConceptNodeComponent
  - Edge rendering differentiates by edgeType
  </verify>
  <done>Custom node extracted with React.memo, edge types render differently, onNodeClick wired up</done>
</task>

<task type="auto">
  <name>Task 2: NodeDetailPanel with metadata, prerequisites, edit mode, and concept PATCH endpoint</name>
  <files>
    adaptive-tutor/src/components/graph/NodeDetailPanel.tsx
    adaptive-tutor/src/app/api/study-plans/[id]/concepts/[conceptId]/route.ts
    adaptive-tutor/src/lib/store.ts
    adaptive-tutor/src/lib/types.ts
  </files>
  <action>
  1. Update `types.ts`: Add `edgeType?: string` to the `ConceptEdge` interface (optional field, defaults to "prerequisite" at DB level).

  2. Update `store.ts`: Add `targetConceptId: string | null` (initial: null) and `setTargetConceptId` action to AppState. This is used by the Practice CTA to tell the Learn tab which concept to focus on.

  3. Create `src/components/graph/NodeDetailPanel.tsx`:
     Props: `{ concept: ConceptNode; edges: ConceptEdge[]; nodes: ConceptNode[]; onClose: () => void; onConceptSelect: (id: string) => void }`

     Layout (absolute right-side panel, w-80, full height, z-20, border-left, overflow-y-auto):

     a. **Header**: Concept name (h3), difficulty tier badge (1/2/3 with color), close button (X icon from lucide-react)

     b. **Proficiency section**:
        - Proficiency bar (horizontal, colored using proficiencyColor helper)
        - Percentage text (e.g., "65%")
        - Confidence indicator (text: "Estimated" if confidence < 0.5, "Tested" if >= 0.5)
        - Attempt count and last practiced date (using formatDate from utils)

     c. **Description**: Concept description text

     d. **Key Terms**: Parse `keyTermsJson` with `safeJsonParse`, render as pill/tag badges

     e. **Prerequisites**: Filter `edges` where `edge.toNodeId === concept.id`, find corresponding node names. Render as clickable list items. On click: call `onConceptSelect(prereqId)`.

     f. **Dependents**: Filter `edges` where `edge.fromNodeId === concept.id`, find corresponding node names. Render as clickable list items. On click: call `onConceptSelect(depId)`.

     g. **Practice CTA**: "Practice this concept" button. On click:
        - `useAppStore.getState().setTargetConceptId(concept.id)`
        - `useAppStore.getState().setActiveTab("learn")`

     h. **Edit Mode**: Toggle button "Edit". When active:
        - Name: text input, pre-filled
        - Description: textarea, pre-filled
        - Key Terms: comma-separated text input, pre-filled with parsed terms joined by ", "
        - "Save" button: calls `PATCH /api/study-plans/${concept.studyPlanId}/concepts/${concept.id}` with updated fields
        - On save success: update concept in Zustand store optimistically via `setConceptNodes` (map over nodes, replace matching id)
        - "Cancel" button: exit edit mode, revert to display

     Style with Tailwind classes and CSS vars consistent with the rest of the app (`var(--bg-secondary)`, `var(--border)`, `var(--text-primary)`, etc.)

  4. Create API endpoint `src/app/api/study-plans/[id]/concepts/[conceptId]/route.ts`:
     - PATCH handler: accepts `{ name?, description?, keyTermsJson? }` in body
     - Validates conceptId belongs to the study plan
     - Uses `update` from `@/lib/db` to update the ConceptNode
     - Returns updated concept
     - If keyTerms comes as an array (from frontend), stringify it before saving

  5. Wire NodeDetailPanel into `graph/page.tsx`:
     - Import NodeDetailPanel
     - Render conditionally when `selectedConcept` is not null
     - Pass `edges: conceptEdges`, `nodes: conceptNodes`, `onClose: () => setSelectedConcept(null)`, `onConceptSelect: (id) => setSelectedConcept(conceptNodes.find(c => c.id === id) ?? null)`
  </action>
  <verify>
  - `npx tsc --noEmit` passes
  - NodeDetailPanel.tsx exists with all sections (header, proficiency, description, key terms, prereqs, dependents, practice CTA, edit mode)
  - PATCH endpoint exists and handles concept updates
  - Clicking a node in the graph opens the panel (manual browser test)
  - Edit mode saves changes and updates store
  </verify>
  <done>Full node detail panel with metadata display, prerequisites/dependents navigation, Practice CTA, and inline edit mode</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd adaptive-tutor && npx tsc --noEmit`
2. Graph page loads in browser with no console errors
3. Custom nodes render with proficiency colors (test with seeded data or after 02-01 generates a graph)
4. Clicking a node opens the detail panel on the right
5. Detail panel shows correct concept info, prerequisites, dependents
6. Edit mode works and persists changes
7. Practice CTA navigates to Learn tab
8. Escape key closes the panel
9. Edge types render differently (solid vs dashed) -- may need 02-01's edgeType data to test fully
</verification>

<success_criteria>
- ConceptNode is React.memo wrapped and extracted to separate file
- Edge rendering distinguishes prerequisite (solid) from helpful (dashed)
- Node click opens detail panel with full metadata
- Practice CTA navigates to Learn tab with targeted concept
- Edit mode saves changes to API and updates store
- Panel is performant (no jank with 30+ nodes)
</success_criteria>

<output>
After completion, create `.planning/phases/02-graph-generation-and-visualization/02-03-SUMMARY.md`
</output>
