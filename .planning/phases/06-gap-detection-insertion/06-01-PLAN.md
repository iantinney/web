---
phase: 06-gap-detection-insertion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - adaptive-tutor/prisma/schema.prisma
  - adaptive-tutor/src/lib/types.ts
  - adaptive-tutor/src/lib/schemas.ts
  - adaptive-tutor/src/lib/prompts/index.ts
  - adaptive-tutor/src/app/api/study-plans/[id]/attempt/route.ts
autonomous: true

must_haves:
  truths:
    - "GapDetection records are created when the LLM classifies an error as PREREQUISITE_GAP"
    - "Free response grading returns errorType and gapAnalysis fields"
    - "GapDetection records persist to SQLite with conceptId, missingConcept, severity, explanation, status"
    - "Non-free-response questions do NOT trigger gap analysis (only free_response questions)"
    - "Attempt response includes gapAnalysis when a gap is detected"
  artifacts:
    - path: "adaptive-tutor/prisma/schema.prisma"
      provides: "GapDetection model with all required fields"
      contains: "model GapDetection"
    - path: "adaptive-tutor/src/lib/types.ts"
      provides: "GapDetection TypeScript interface + GapAnalysis type"
      contains: "interface GapDetection"
    - path: "adaptive-tutor/src/lib/schemas.ts"
      provides: "Zod schema for enhanced grading LLM output with errorType + gapAnalysis"
      contains: "LLMEnhancedEvaluationSchema"
    - path: "adaptive-tutor/src/lib/prompts/index.ts"
      provides: "Enhanced evaluateFreeResponsePrompt with error classification"
      contains: "PREREQUISITE_GAP"
    - path: "adaptive-tutor/src/app/api/study-plans/[id]/attempt/route.ts"
      provides: "GapDetection record creation on PREREQUISITE_GAP + enhanced response"
      contains: "prisma.gapDetection.create"
  key_links:
    - from: "adaptive-tutor/src/lib/prompts/index.ts"
      to: "adaptive-tutor/src/app/api/study-plans/[id]/attempt/route.ts"
      via: "evaluateFreeResponsePrompt called in attempt route for free_response questions"
      pattern: "evaluateFreeResponsePrompt"
    - from: "adaptive-tutor/src/lib/schemas.ts"
      to: "adaptive-tutor/src/app/api/study-plans/[id]/attempt/route.ts"
      via: "LLMEnhancedEvaluationSchema validates LLM JSON output"
      pattern: "LLMEnhancedEvaluationSchema"
    - from: "adaptive-tutor/src/app/api/study-plans/[id]/attempt/route.ts"
      to: "prisma.gapDetection"
      via: "creates GapDetection record when errorType is PREREQUISITE_GAP"
      pattern: "prisma\\.gapDetection\\.create"
---

<objective>
Add the GapDetection data model, enhance the free response grading prompt with error classification (CORRECT/MINOR/MISCONCEPTION/PREREQUISITE_GAP), and wire gap logging into the attempt route.

Purpose: This is the invisible foundation for gap detection. After this plan, every free response answer gets classified, and PREREQUISITE_GAP errors are logged to the database for later pattern detection.

Output: GapDetection Prisma model + migration, enhanced grading prompt + Zod schema, attempt route that creates GapDetection records and returns gapAnalysis in its response.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-gap-detection-insertion/06-CONTEXT.md
@adaptive-tutor/adaptive-graph-design.md (sections 2.1, 5.1, 6.1)
@adaptive-tutor/prisma/schema.prisma
@adaptive-tutor/src/lib/types.ts
@adaptive-tutor/src/lib/schemas.ts
@adaptive-tutor/src/lib/prompts/index.ts
@adaptive-tutor/src/lib/minimax-native.ts
@adaptive-tutor/src/app/api/study-plans/[id]/attempt/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: GapDetection Prisma model + types + Zod schema</name>
  <files>
    adaptive-tutor/prisma/schema.prisma
    adaptive-tutor/src/lib/types.ts
    adaptive-tutor/src/lib/schemas.ts
  </files>
  <action>
**1a. Add GapDetection model to prisma/schema.prisma:**

Add this model after the existing SessionRecord model:

```prisma
model GapDetection {
  id                String   @id @default(cuid())
  userId            String
  conceptId         String       // The concept the user was practicing when gap was detected
  missingConcept    String       // The prerequisite concept name the LLM identified as missing
  severity          String       // NARROW | MODERATE | BROAD
  explanation       String       // LLM's reasoning for why this is a gap
  attemptId         String?      // The specific attempt that triggered this detection
  unitGraphId       String?      // The unit graph context where the gap was detected
  status            String   @default("detected")  // detected | proposed | accepted | declined
  createdAt         DateTime @default(now())

  concept           Concept  @relation(fields: [conceptId], references: [id], onDelete: Cascade)

  @@index([userId, conceptId])
  @@index([userId, missingConcept])
}
```

Also add the reverse relation on the Concept model. Find the Concept model and add to its relations:
```prisma
  gapDetections      GapDetection[]
```

Add it after the `edgesTo` relation line.

**1b. Run the Prisma migration:**

```bash
cd adaptive-tutor && npx prisma db push
```

Use `db push` (not `migrate dev`) since this is a hackathon SQLite project. This is the pattern used throughout the project.

**1c. Add GapDetection interface to src/lib/types.ts:**

After the SessionRecord interface, add:

```typescript
export interface GapDetection {
  id: string;
  userId: string;
  conceptId: string;
  missingConcept: string;
  severity: "NARROW" | "MODERATE" | "BROAD";
  explanation: string;
  attemptId: string | null;
  unitGraphId: string | null;
  status: "detected" | "proposed" | "accepted" | "declined";
  createdAt: string;
}

export interface GapAnalysis {
  missingConcept: string;
  severity: "NARROW" | "MODERATE" | "BROAD";
  explanation: string;
}

export type ErrorType = "CORRECT" | "MINOR" | "MISCONCEPTION" | "PREREQUISITE_GAP";
```

Also update the existing `LLMEvaluation` interface to include the new fields:

```typescript
export interface LLMEvaluation {
  isCorrect: boolean;
  score: number;
  feedback: string;
  misconceptions: string[];
  errorType?: ErrorType;
  gapAnalysis?: GapAnalysis;
}
```

**1d. Add enhanced evaluation Zod schema to src/lib/schemas.ts:**

After the existing `LLMEvaluationSchema`, add:

```typescript
export const GapAnalysisSchema = z.object({
  missingConcept: z.string().min(1),
  severity: z.enum(["NARROW", "MODERATE", "BROAD"]),
  explanation: z.string().min(1),
});

export const LLMEnhancedEvaluationSchema = z.object({
  isCorrect: z.boolean(),
  score: z.number().min(0).max(1),
  feedback: z.string(),
  misconceptions: z.array(z.string()).default([]),
  errorType: z.enum(["CORRECT", "MINOR", "MISCONCEPTION", "PREREQUISITE_GAP"]),
  gapAnalysis: GapAnalysisSchema.optional(),
});
```

This schema validates the enhanced LLM output. The `gapAnalysis` field is optional because it only appears when `errorType` is `PREREQUISITE_GAP`.
  </action>
  <verify>
Run `cd /home/antel/hackathon/adaptive-tutor && npx prisma db push` succeeds without errors.
Run `cd /home/antel/hackathon/adaptive-tutor && npx tsc --noEmit` passes (no TypeScript errors).
Verify GapDetection model exists: `npx prisma studio` or check that the schema file contains `model GapDetection`.
  </verify>
  <done>
GapDetection model exists in Prisma schema, migration applied to SQLite, TypeScript types and Zod schemas added and compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhanced grading prompt + attempt route gap logging</name>
  <files>
    adaptive-tutor/src/lib/prompts/index.ts
    adaptive-tutor/src/app/api/study-plans/[id]/attempt/route.ts
  </files>
  <action>
**2a. Enhance the `evaluateFreeResponsePrompt` in src/lib/prompts/index.ts:**

Replace the existing `evaluateFreeResponsePrompt` function with an enhanced version that includes error classification. Keep the same function signature. The new prompt must:

1. Keep all existing evaluation logic (isCorrect, score, feedback, misconceptions)
2. Add error classification instruction block
3. Add gapAnalysis output for PREREQUISITE_GAP errors
4. Include the conservative calibration instruction from the design doc

New prompt output format should be:

```
{
  "isCorrect": true/false,
  "score": 0.0-1.0,
  "feedback": "Targeted feedback addressing specific gaps or confirming understanding",
  "misconceptions": ["list", "of", "any", "incorrect", "beliefs"],
  "errorType": "CORRECT" | "MINOR" | "MISCONCEPTION" | "PREREQUISITE_GAP",
  "gapAnalysis": {
    "missingConcept": "Chain Rule",
    "severity": "NARROW",
    "explanation": "The student's attempt to differentiate a composite function shows no awareness of the chain rule"
  }
}
```

Key prompt additions (append after the existing RULES section):

```
ERROR CLASSIFICATION (required for ALL responses):
After evaluating correctness, classify the error:
- CORRECT: No error (isCorrect is true)
- MINOR: Arithmetic, recall, or terminology slip. The student understands the concept.
- MISCONCEPTION: Misunderstands THIS concept specifically. Needs more practice on it.
- PREREQUISITE_GAP: The error reveals missing knowledge of a DIFFERENT, more foundational
  concept that is not the one being tested. The student cannot succeed at this concept
  without first learning the prerequisite.

IMPORTANT: Be conservative with PREREQUISITE_GAP classification.
- Most wrong answers are MINOR or MISCONCEPTION, NOT PREREQUISITE_GAP.
- Only classify as PREREQUISITE_GAP when the student's answer demonstrates a fundamental
  misunderstanding that CANNOT be fixed by more practice on the current concept alone.
- The missing prerequisite must be a DIFFERENT concept from the one being tested.

If errorType is CORRECT, MINOR, or MISCONCEPTION: omit "gapAnalysis" from your response.
If errorType is PREREQUISITE_GAP, include "gapAnalysis" with:
- missingConcept: The specific name of the missing prerequisite (e.g., "Chain Rule" not "calculus")
- severity: NARROW (one concept), MODERATE (2-4 related concepts), or BROAD (entire domain)
- explanation: One sentence explaining what in the student's answer reveals this gap
```

Make sure the JSON output schema in the prompt includes the new fields (errorType, gapAnalysis).

**2b. Modify POST /api/study-plans/[id]/attempt/route.ts:**

The current attempt route has a Phase 3 stub for free_response that returns neutral results. Replace this with actual LLM evaluation using the enhanced prompt.

Changes needed:

1. Import `generateText` from `@/lib/minimax-native`
2. Import `evaluateFreeResponsePrompt` from `@/lib/prompts`
3. Import `LLMEnhancedEvaluationSchema, parseLLMJson` from `@/lib/schemas`
4. Import the prisma client (already imported)

5. In the `if (question.questionType === "free_response")` block (around line 95-99), replace the stub with:

```typescript
if (question.questionType === "free_response") {
  // Enhanced LLM evaluation with gap analysis
  try {
    const evalPrompt = evaluateFreeResponsePrompt(
      question.questionText,
      question.correctAnswer,
      String(userAnswer),
      concept.name
    );
    const llmRaw = await generateText(
      [{ role: "user", content: "Evaluate this answer." }],
      evalPrompt,
      { model: process.env.MINIMAX_STRUCTURED_MODEL || "MiniMax-Text-01", temperature: 0.3, maxTokens: 1024 }
    );
    const parsed = LLMEnhancedEvaluationSchema.parse(parseLLMJson(llmRaw));
    isCorrect = parsed.isCorrect;
    score = parsed.score;
    feedback = parsed.feedback;
    // Store errorType and gapAnalysis for response
    errorType = parsed.errorType;
    gapAnalysis = parsed.gapAnalysis ?? null;
  } catch (evalError) {
    console.error("[attempt] Free response LLM evaluation failed:", evalError);
    // Fallback: neutral treatment (same as Phase 3 stub)
    isCorrect = false;
    feedback = "Answer recorded. Evaluation temporarily unavailable.";
    score = 0.5;
  }
}
```

6. Declare `errorType` and `gapAnalysis` variables at the top of the evaluation block (around line 92):

```typescript
let errorType: string | null = null;
let gapAnalysis: { missingConcept: string; severity: string; explanation: string } | null = null;
```

7. After the atomic transaction (around line 201), add GapDetection logging. Insert BEFORE the response return:

```typescript
// Log gap detection if PREREQUISITE_GAP was identified
if (errorType === "PREREQUISITE_GAP" && gapAnalysis) {
  // Fire-and-forget: don't block the response
  prisma.gapDetection.create({
    data: {
      userId,
      conceptId: concept.id,
      missingConcept: gapAnalysis.missingConcept,
      severity: gapAnalysis.severity,
      explanation: gapAnalysis.explanation,
      attemptId: null, // We don't have the attemptId from the transaction easily; omit for now
      unitGraphId: session.unitGraphId ?? null,
      status: "detected",
    },
  }).catch((err) => {
    console.error("[attempt] Failed to log gap detection:", err);
  });
}
```

8. Add gapAnalysis to the response JSON. Update the return statement (around line 208) to include:

```typescript
return NextResponse.json({
  isCorrect,
  feedback,
  explanation: question.explanation || null,
  score,
  errorType: errorType ?? (isCorrect ? "CORRECT" : null),
  gapAnalysis: gapAnalysis ?? undefined,
  proficiencyUpdate: { /* ... existing ... */ },
  sessionUpdate: { /* ... existing ... */ },
  sessionComplete: false,
});
```

**Important implementation notes:**
- Use `MiniMax-Text-01` model (structured output model) for grading, NOT `MiniMax-M2.5` (streaming model). The env var `MINIMAX_STRUCTURED_MODEL` may override this. This is consistent with how question generation uses Text-01.
- The LLM call adds latency to free_response submissions (~2-3s). This is acceptable because the user is waiting for feedback anyway.
- The GapDetection create is fire-and-forget to not block the response.
- Keep proficiency update logic UNCHANGED for free_response. The current stub gives `score: 0.5` and skips proficiency update. With real LLM evaluation, use the actual `isCorrect` and `score` values. Remove the special-case that skips proficiency update for free_response (line 137 condition).
  </action>
  <verify>
1. `cd /home/antel/hackathon/adaptive-tutor && npx tsc --noEmit` passes.
2. `cd /home/antel/hackathon/adaptive-tutor && npm run build` succeeds.
3. Manually verify: Start the app, go to Learn tab, answer a free_response question wrong. Check the API response in Network tab â€” it should include `errorType` and possibly `gapAnalysis` fields.
4. Check SQLite: `npx prisma studio` and look at GapDetection table for any records after answering wrong.
  </verify>
  <done>
Free response answers are evaluated by MiniMax with error classification. PREREQUISITE_GAP errors create GapDetection records in the database. The attempt response includes errorType and gapAnalysis fields. Build passes with zero errors.
  </done>
</task>

</tasks>

<verification>
1. `npx prisma db push` succeeds (schema migration applied)
2. `npx tsc --noEmit` passes (no TypeScript errors)
3. `npm run build` succeeds (no build errors)
4. GapDetection model exists in Prisma schema with all required fields
5. Enhanced grading prompt includes error classification instructions
6. Attempt route calls LLM for free_response and creates GapDetection records
7. Attempt response includes errorType and gapAnalysis when applicable
</verification>

<success_criteria>
- GapDetection Prisma model persists gap observations to SQLite
- Free response grading classifies errors as CORRECT/MINOR/MISCONCEPTION/PREREQUISITE_GAP
- PREREQUISITE_GAP errors create GapDetection records with missingConcept, severity, explanation
- Attempt API response includes errorType and gapAnalysis fields
- Non-free-response questions continue to work unchanged (no regression)
- Build passes with zero TypeScript/runtime errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-gap-detection-insertion/06-01-SUMMARY.md`
</output>
