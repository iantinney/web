---
phase: 08-session-lifecycle-tab-persistence-and-integration-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - adaptive-tutor/src/app/(tabs)/learn/page.tsx
autonomous: true
requirements: []

must_haves:
  truths:
    - "Switching from Learn tab to another tab mid-session does not end the session — returning restores practice state"
    - "Free response answers display actual LLM evaluation feedback, not the stale Phase 4 placeholder text"
    - "Session summary shows per-concept accuracy and proficiency delta for each concept practiced"
  artifacts:
    - path: "adaptive-tutor/src/app/(tabs)/learn/page.tsx"
      provides: "Session lifecycle fix, free response feedback fix, per-concept session summary"
      contains: "sessionCompletedRef"
  key_links:
    - from: "adaptive-tutor/src/app/(tabs)/learn/page.tsx"
      to: "handleAdvance"
      via: "sessionCompletedRef.current = true before PATCH"
      pattern: "sessionCompletedRef\\.current\\s*=\\s*true"
    - from: "adaptive-tutor/src/app/(tabs)/learn/page.tsx"
      to: "lastResult.feedback"
      via: "free_response branch in feedback render"
      pattern: "lastResult\\.feedback"
---

<objective>
Fix the Learn tab's three major post-Phase-7 issues: premature session termination on tab switch, stale free response placeholder text, and missing per-concept session summary.

Purpose: The session PATCH bug silently destroys in-progress sessions when users navigate away. The free response placeholder text ("Phase 4") ships stale UX even though Phase 6 provides real LLM feedback. The flat session summary misses actionable per-concept data.

Output: Modified learn/page.tsx with conditional session PATCH, real free response feedback display, and per-concept proficiency delta in the session summary.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-session-lifecycle-tab-persistence-and-integration-polish/08-RESEARCH.md
@adaptive-tutor/src/app/(tabs)/learn/page.tsx
@adaptive-tutor/src/lib/store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix premature session PATCH on tab switch</name>
  <files>adaptive-tutor/src/app/(tabs)/learn/page.tsx</files>
  <action>
    The session cleanup `useEffect` (around lines 327-342) calls PATCH unconditionally on unmount, which fires on tab switch. This must be made conditional so only explicit session completion triggers PATCH.

    Steps:
    1. Add `const sessionCompletedRef = useRef(false);` near the other refs (skipFeedbackRef, advanceTimerRef).

    2. Locate `handleAdvance` — the function that advances to the next question. Find the branch where `nextIndex >= questions.length` (all questions exhausted). This is where the session naturally completes. In that branch:
       - Set `sessionCompletedRef.current = true` BEFORE the fetch PATCH call.
       - The PATCH call stays here — it now fires only on explicit completion.

    3. In the cleanup `useEffect` that currently fires PATCH on unmount, REMOVE the fetch PATCH call entirely. The cleanup should only:
       - Clear `advanceTimerRef.current` if set
       - Call `setCurrentSession(null)` and `setTargetConceptId(null)` (these are local state, safe to clear)
       - Do NOT call PATCH
       - Do NOT reset `learnPhase` or `learnActiveStudyPlanId` in Zustand — those must remain for the tab-switch restore guard to work (lines 148-173)

    Also reset `sessionCompletedRef.current = false` whenever a new session starts (where `sessionId` is set from the new session response).

    CRITICAL: Do not modify the tab-switch restore guard (the useEffect around lines 148-173 that checks `learnActiveStudyPlanId === activeStudyPlanId`). This guard must remain unchanged.

    ANTI-PATTERN: Do not use `document.visibilityState` or any visibility API. Use the ref flag approach only.
  </action>
  <verify>
    <automated>cd /Users/rykkim/Documents/githublocal/yale-agentic-ai-hackathon/adaptive-tutor && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Start a practice session, switch to Graph tab, return to Learn tab. Session should resume at the same question, not restart. Check Network tab — no PATCH request should fire on the switch.</manual>
  </verify>
  <done>TypeScript compiles clean. Tab switch does not emit a PATCH request. Returning to Learn tab resumes the active session. Completing all questions still emits one PATCH to end the session.</done>
</task>

<task type="auto">
  <name>Task 2: Fix free response feedback + add per-concept session summary</name>
  <files>adaptive-tutor/src/app/(tabs)/learn/page.tsx</files>
  <action>
    Two related fixes in the same file — both affect how learn/page.tsx displays results.

    **Fix A: Update AttemptResult interface**
    Find the `AttemptResult` interface (around lines 19-37). Add the missing fields that Phase 6's attempt route now returns:
    ```typescript
    errorType?: string | null;
    gapAnalysis?: {
      missingPrerequisite?: string | null;
      missingConcept?: string | null;
      confidence?: number | null;
    } | null;
    ```

    **Fix B: Replace stale free response placeholder**
    Find the feedback render section (around lines 1460-1463):
    ```typescript
    // CURRENT (stale):
    {currentQuestion.questionType === "free_response"
      ? "Answer recorded. Evaluation coming in Phase 4."
      : lastResult.explanation}
    ```
    Replace with:
    ```typescript
    {currentQuestion.questionType === "free_response"
      ? (lastResult.feedback || lastResult.explanation || "Answer recorded.")
      : lastResult.explanation}
    ```
    Using `lastResult.feedback || lastResult.explanation` as fallback chain handles both the free response case (which has `feedback` from LLM) and the structured types (which have `explanation`).

    **Fix C: Per-concept session summary**
    1. Add state: `const [sessionAttempts, setSessionAttempts] = useState<AttemptResult[]>([]);`
    2. In `submitAttempt` (the function that calls the attempt API and gets back a result), after updating `lastResult`, also accumulate: `setSessionAttempts(prev => [...prev, result]);`
    3. Reset `sessionAttempts` when a new session starts: where the session starts and `sessionId` is set, also call `setSessionAttempts([])`.
    4. In the "complete" phase render (around lines 840-1003), after the existing flat concept list, add a per-concept breakdown table:
       - Group `sessionAttempts` by `conceptId`
       - For each concept: show concept name, attempts count, correct count, accuracy %, and proficiency delta (lastAttempt.proficiencyUpdate.newProficiency - firstAttempt.proficiencyUpdate.previousProficiency)
       - Display using Tailwind CSS with CSS variable colors (e.g., `style={{ color: 'var(--color-text-secondary)' }}`). Do NOT use shadcn/ui (ui/ dir is empty in this project).
       - Use a simple grid or list layout consistent with the existing summary styling.

    IMPORTANT: `sessionAttempts` is local state (useState), not Zustand — per-session accumulation does not need to survive tab switches. The session summary is only visible when `phase === "complete"` which requires the user to finish all questions in one tab.
  </action>
  <verify>
    <automated>cd /Users/rykkim/Documents/githublocal/yale-agentic-ai-hackathon/adaptive-tutor && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>1. Submit a free response answer — verify LLM feedback text appears (not "Phase 4" placeholder). 2. Complete a full practice session — verify session summary shows per-concept breakdown with accuracy and proficiency delta per concept.</manual>
  </verify>
  <done>TypeScript compiles clean. Free response feedback section shows actual LLM-generated feedback text. Session complete screen shows a per-concept table with accuracy % and proficiency delta for each practiced concept.</done>
</task>

</tasks>

<verification>
Run `cd /Users/rykkim/Documents/githublocal/yale-agentic-ai-hackathon/adaptive-tutor && npx tsc --noEmit` — must pass with 0 errors.

Functional checks:
1. Mid-session tab switch: navigate Learn → Graph → Learn. No PATCH in network. Session resumes.
2. Session complete: navigate Learn → Graph → Learn, complete remaining questions. One PATCH fires.
3. Free response feedback: submit a free_response answer. Feedback section shows LLM text, not "Phase 4."
4. Session summary: complete a session. Summary section shows per-concept rows with accuracy and delta.
</verification>

<success_criteria>
- Zero TypeScript compile errors
- Tab switch does not trigger session PATCH (verified via network tab or server logs)
- Free response questions display real LLM feedback after submission
- Session summary includes per-concept accuracy and proficiency delta breakdown
</success_criteria>

<output>
After completion, create `.planning/phases/08-session-lifecycle-tab-persistence-and-integration-polish/08-01-SUMMARY.md`
</output>
