---
phase: 08-session-lifecycle-tab-persistence-and-integration-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - adaptive-tutor/src/app/(tabs)/chat/page.tsx
autonomous: true
requirements: []

must_haves:
  truths:
    - "Chat UI does not stay permanently locked in a disabled state after tab-switching mid-plan-approval"
    - "Starting a new conversation from the completed state does not show the previous lesson plan card"
    - "Chat tab displays a passive banner when a Learn session is active"
  artifacts:
    - path: "adaptive-tutor/src/app/(tabs)/chat/page.tsx"
      provides: "chatPhase recovery guard, chatLessonPlan reset, active session banner"
      contains: "chatPhase === \"structuring\""
  key_links:
    - from: "adaptive-tutor/src/app/(tabs)/chat/page.tsx"
      to: "chatPhase recovery useEffect"
      via: "mount-time guard resetting stuck structuring phase"
      pattern: "chatPhase.*structuring.*setChatPhase"
    - from: "adaptive-tutor/src/app/(tabs)/chat/page.tsx"
      to: "setChatLessonPlan(null)"
      via: "done → gathering transition in handleSubmit"
      pattern: "setChatLessonPlan\\(null\\)"
---

<objective>
Fix two bugs in the Chat tab (stuck structuring phase, stale chatLessonPlan) and add a passive banner showing active Learn session context.

Purpose: The stuck-structuring bug permanently disables the chat input if the user navigates away during plan approval. The chatLessonPlan bug shows a stale lesson plan card when starting a new conversation. The banner improves cross-tab UX by making the chat context-aware of active practice.

Output: Modified chat/page.tsx with mount recovery guard, chatLessonPlan reset on new conversation, and a learn-session-active banner.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-session-lifecycle-tab-persistence-and-integration-polish/08-RESEARCH.md
@adaptive-tutor/src/app/(tabs)/chat/page.tsx
@adaptive-tutor/src/lib/store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix chat stuck-state + chatLessonPlan reset</name>
  <files>adaptive-tutor/src/app/(tabs)/chat/page.tsx</files>
  <action>
    Two bug fixes in the same file.

    **Fix A: chatPhase "structuring" recovery guard**
    The `chatPhase` field is Zustand-persisted. If the user navigates away during `handleApprove()` (while chatPhase === "structuring"), the phase stays stuck permanently, disabling the textarea and send button forever.

    Add a mount-time recovery `useEffect` that fires once when the component mounts. Place it alongside the existing useEffects near the top of the component:
    ```typescript
    // Recovery: if chatPhase is stuck in "structuring" from a prior interrupted operation, recover
    useEffect(() => {
      if (chatPhase === "structuring") {
        setChatPhase("proposing");
      }
    }, []); // intentional empty deps — mount-only check
    ```

    `setChatPhase` is already available from the Zustand store destructure at the top of the component. This one-line recovery prevents the UI from being permanently locked.

    **Fix B: chatLessonPlan not cleared on new conversation**
    In `handleSubmit` (around lines 122-130), find the branch that handles the transition from `chatPhase === "done"` back to `"gathering"` (when the user sends a new message after completing a study plan). The existing code calls `setProposedLessonPlan(null)` but does NOT call `setChatLessonPlan(null)`.

    Add `setChatLessonPlan(null)` directly after `setProposedLessonPlan(null)` in that done-to-gathering branch. Only add it in the `chatPhase === "done"` branch — do not add it on tab switch or page refresh.

    `setChatLessonPlan` is already available from the Zustand store (resetChatState already uses it at lines 238-246 in store.ts). Destructure it from `useAppStore` at the top of the component if not already present.
  </action>
  <verify>
    <automated>cd /Users/rykkim/Documents/githublocal/yale-agentic-ai-hackathon/adaptive-tutor && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>1. Start plan approval (structuring phase), immediately switch to Learn tab, return to Chat. Textarea should be enabled — not permanently grayed out. 2. Complete a study plan flow, then type a new message. The previous lesson plan card should not appear in the chat.</manual>
  </verify>
  <done>TypeScript compiles clean. Returning to Chat tab after mid-approval navigation shows an enabled input. Starting a new conversation from the done state does not display the previous chatLessonPlan card.</done>
</task>

<task type="auto">
  <name>Task 2: Add active Learn session banner to Chat tab</name>
  <files>adaptive-tutor/src/app/(tabs)/chat/page.tsx</files>
  <action>
    Add a passive, non-dismissable info banner to the Chat tab that appears when the user has an active Learn session running (learnPhase === "practicing" or "feedback" in Zustand).

    Steps:
    1. Read `learnPhase` from Zustand store. It's already in the store (used by learn/page.tsx). Add to the store destructure at the top of chat/page.tsx:
       ```typescript
       const learnPhase = useAppStore((s) => s.learnPhase);
       ```

    2. Derive an `activeSession` boolean:
       ```typescript
       const activeSession = learnPhase === "practicing" || learnPhase === "feedback";
       ```

    3. Render a banner at the top of the chat messages area (above the message list, below the tab/header). Use Tailwind CSS v4 and CSS variables for styling — DO NOT use shadcn/ui (the ui/ directory is empty in this project):
       ```tsx
       {activeSession && (
         <div
           className="px-4 py-2 text-xs border-b"
           style={{
             backgroundColor: 'var(--color-surface-secondary, #1e293b)',
             color: 'var(--color-text-secondary, #94a3b8)',
             borderColor: 'var(--color-border, #334155)',
           }}
         >
           Practice session active — your questions are personalized to your current learning context.
         </div>
       )}
       ```

    Place the banner inside the chat layout, above the scrollable message list but inside the main content area. Look at the existing layout structure to find the correct insertion point (likely just before the messages `div` with overflow-y-auto).

    The banner is intentionally non-clickable and non-dismissable — it's a passive indicator only.
  </action>
  <verify>
    <automated>cd /Users/rykkim/Documents/githublocal/yale-agentic-ai-hackathon/adaptive-tutor && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>1. Start a practice session in Learn tab. Switch to Chat tab. A small banner should appear above the messages reading "Practice session active..." 2. Complete or stop the session. Return to Chat tab. Banner should be gone.</manual>
  </verify>
  <done>TypeScript compiles clean. Chat tab shows a subdued banner when learnPhase is "practicing" or "feedback". Banner disappears when learnPhase returns to "idle" or "complete".</done>
</task>

</tasks>

<verification>
Run `cd /Users/rykkim/Documents/githublocal/yale-agentic-ai-hackathon/adaptive-tutor && npx tsc --noEmit` — must pass with 0 errors.

Functional checks:
1. Stuck-state recovery: interrupt plan approval by switching tabs → return → chat is usable.
2. chatLessonPlan reset: complete a plan → send new message → no old lesson plan card visible.
3. Active session banner: start Learn session → switch to Chat → banner visible; end session → banner gone.
</verification>

<success_criteria>
- Zero TypeScript compile errors
- Chat input is always recoverable after tab-switch interruption during plan approval
- Starting a new conversation from "done" state shows a clean chat with no stale lesson plan
- A passive banner appears in Chat tab when a Learn session is active, disappears when inactive
</success_criteria>

<output>
After completion, create `.planning/phases/08-session-lifecycle-tab-persistence-and-integration-polish/08-02-SUMMARY.md`
</output>
