---
phase: 09-web-style-force-directed-graph-layout-via-backend-positioning
plan: 03
type: execute
wave: 2
depends_on:
  - 09-01
  - 09-02
files_modified:
  - adaptive-tutor/src/components/graph/AddConceptFAB.tsx
  - adaptive-tutor/src/lib/prompts/index.ts
  - adaptive-tutor/src/app/api/study-plans/[id]/concepts/add-custom/route.ts
  - adaptive-tutor/src/app/(tabs)/graph/page.tsx
autonomous: true
requirements:
  - LAYOUT-04

must_haves:
  truths:
    - "User can tap a floating + button in graph view to add a custom concept"
    - "After entering concept name, node appears in graph with LLM-inferred edges automatically"
    - "Custom concepts have no questions until user first practices them (on-demand generation)"
    - "The graph immediately reflows to accommodate the new node"
    - "Invalid LLM edge inferences (non-existent concepts, cycle-creating edges) are silently dropped"
  artifacts:
    - path: "adaptive-tutor/src/components/graph/AddConceptFAB.tsx"
      provides: "Floating action button + form overlay for custom concept name input"
      exports: ["AddConceptFAB"]
    - path: "adaptive-tutor/src/app/api/study-plans/[id]/concepts/add-custom/route.ts"
      provides: "POST endpoint: create concept + LLM edge inference + force layout recompute"
      exports: ["POST"]
    - path: "adaptive-tutor/src/lib/prompts/index.ts"
      provides: "edgeInferencePrompt function for LLM edge connection"
      exports: ["edgeInferencePrompt"]
  key_links:
    - from: "adaptive-tutor/src/components/graph/AddConceptFAB.tsx"
      to: "adaptive-tutor/src/app/api/study-plans/[id]/concepts/add-custom/route.ts"
      via: "fetch POST with concept name"
      pattern: "fetch.*concepts/add-custom"
    - from: "adaptive-tutor/src/app/api/study-plans/[id]/concepts/add-custom/route.ts"
      to: "adaptive-tutor/src/lib/prompts/index.ts"
      via: "import edgeInferencePrompt for LLM call"
      pattern: "import.*edgeInferencePrompt.*from.*prompts"
    - from: "adaptive-tutor/src/app/api/study-plans/[id]/concepts/add-custom/route.ts"
      to: "adaptive-tutor/src/lib/algorithms/forceLayout.ts"
      via: "import computeForceLayout for layout recompute after insertion"
      pattern: "import.*computeForceLayout.*from.*forceLayout"
    - from: "adaptive-tutor/src/app/(tabs)/graph/page.tsx"
      to: "adaptive-tutor/src/components/graph/AddConceptFAB.tsx"
      via: "renders AddConceptFAB with studyPlanId and unitGraphId props"
      pattern: "AddConceptFAB"
---

<objective>
Enable user-initiated custom concept addition to the knowledge graph via a floating action button. The LLM infers edge connections automatically, the graph reflows with the new node, and questions are generated on-demand when the user first practices.

Purpose: Let users extend their knowledge graph beyond what the system generated — personalizing their learning path by adding concepts they care about. The auto-connect via LLM ensures the new concept integrates meaningfully into the existing web.

Output: `AddConceptFAB.tsx` component, `edgeInferencePrompt` in prompts/index.ts, `/api/study-plans/[id]/concepts/add-custom` endpoint, updated graph page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-web-style-force-directed-graph-layout-via-backend-positioning/09-RESEARCH.md
@.planning/phases/09-web-style-force-directed-graph-layout-via-backend-positioning/09-01-SUMMARY.md
@.planning/phases/09-web-style-force-directed-graph-layout-via-backend-positioning/09-02-SUMMARY.md
@adaptive-tutor/src/lib/prompts/index.ts
@adaptive-tutor/src/app/api/study-plans/[id]/concepts/insert/route.ts
@adaptive-tutor/src/app/(tabs)/graph/page.tsx
@adaptive-tutor/src/lib/algorithms/forceLayout.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create edgeInferencePrompt and AddConceptFAB component</name>
  <files>
    adaptive-tutor/src/lib/prompts/index.ts
    adaptive-tutor/src/components/graph/AddConceptFAB.tsx
  </files>
  <action>
**1. Add `edgeInferencePrompt` to `adaptive-tutor/src/lib/prompts/index.ts`:**

Add this export function at the end of the file:

```typescript
export function edgeInferencePrompt(
  newConceptName: string,
  existingConcepts: { id: string; name: string; description: string }[]
): string {
  const conceptList = existingConcepts
    .map((c) => `- "${c.name}" (ID: ${c.id}): ${c.description}`)
    .join("\n");

  return `You are connecting a new concept to an existing knowledge graph.

NEW CONCEPT: "${newConceptName}"

EXISTING CONCEPTS IN THE GRAPH:
${conceptList}

Determine which existing concepts should connect to the new concept.
- "prerequisite_of" means the existing concept must be learned BEFORE the new concept
- "dependent_on" means the new concept must be learned BEFORE the existing concept

OUTPUT ONLY VALID JSON. No markdown fences, no preamble.
{
  "edges": [
    {
      "existingConceptId": "concept-id-here",
      "direction": "prerequisite_of",
      "confidence": 0.9
    }
  ],
  "suggestedDescription": "1-2 sentence description of the new concept",
  "suggestedDifficultyTier": 2,
  "suggestedKeyTerms": ["term1", "term2", "term3"]
}

RULES:
- Only connect to concepts that have a clear learning relationship
- Prefer 1-3 connections (not every concept)
- Higher confidence means stronger pedagogical relationship
- If the new concept is foundational, it should be prerequisite_of advanced concepts
- If the new concept is advanced, existing foundations should be prerequisite_of it
- The resulting graph must remain a DAG (no cycles)`;
}
```

**2. Create `adaptive-tutor/src/components/graph/AddConceptFAB.tsx`:**

A floating action button ("+" icon) in the bottom-right of the graph view. Use the **frontend-design skill** for visual polish — glass morphism consistent with existing project style.

**Props:**
```typescript
interface AddConceptFABProps {
  studyPlanId: string;
  unitGraphId: string;
  onConceptAdded: () => void;  // callback to refresh graph data
}
```

**States:**
- `isOpen: boolean` — controls form overlay visibility
- `conceptName: string` — input value
- `isSubmitting: boolean` — loading state during API call

**UI structure:**
- **FAB (closed):** A circular button (48x48) with `+` icon (use Lucide `Plus`). Position: `fixed` or `absolute` in bottom-right corner of graph canvas (use `absolute` with `bottom: 80px, right: 24px` to clear Controls/MiniMap). Glass morphism: `backdrop-filter: blur(12px)`, background from project's dark theme `rgba(18, 18, 26, 0.85)`, border `rgba(255, 255, 255, 0.08)`, glow accent.
- **Form overlay (open):** Appears above the FAB. Contains:
  - Text input for concept name (auto-focus). Placeholder: "Enter concept name..."
  - Submit button: "Add to Graph" with loading spinner while `isSubmitting`.
  - Cancel button or click-outside to close.
  - Input style: dark themed, matches existing project input styling.

**Submit handler:**
```typescript
const handleSubmit = async () => {
  if (!conceptName.trim() || isSubmitting) return;
  setIsSubmitting(true);
  try {
    const res = await fetch(`/api/study-plans/${studyPlanId}/concepts/add-custom`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ unitGraphId, conceptName: conceptName.trim() }),
    });
    if (res.ok) {
      setConceptName("");
      setIsOpen(false);
      onConceptAdded();  // trigger graph data refresh
    }
  } finally {
    setIsSubmitting(false);
  }
};
```

- On Enter key in input, submit. On Escape, close.
- Animation: Use framer-motion for overlay entrance (scale from 0.9 to 1, fade in).
  </action>
  <verify>
    <automated>cd adaptive-tutor && npx tsc --noEmit 2>&1 | grep -c "error" || echo "0 errors"</automated>
    <manual>Verify AddConceptFAB renders in graph view, opens form overlay on click, and edgeInferencePrompt exports from prompts/index.ts</manual>
  </verify>
  <done>edgeInferencePrompt exported from prompts/index.ts. AddConceptFAB component renders a floating + button that opens a form overlay for concept name input. Component handles submit/cancel/keyboard events.</done>
</task>

<task type="auto">
  <name>Task 2: Create add-custom API endpoint and wire FAB into graph page</name>
  <files>
    adaptive-tutor/src/app/api/study-plans/[id]/concepts/add-custom/route.ts
    adaptive-tutor/src/app/(tabs)/graph/page.tsx
  </files>
  <action>
**1. Create `adaptive-tutor/src/app/api/study-plans/[id]/concepts/add-custom/route.ts`:**

`POST` handler. Must `await params` (Next.js 16).

**Request body:** `{ unitGraphId: string, conceptName: string }`

**Flow:**
1. Validate inputs (unitGraphId, conceptName required).
2. Get userId from `x-user-id` header or default "demo-user".
3. Verify study plan exists and belongs to user.
4. Fetch all existing concepts in this unitGraph (via graphMemberships with concept include).
5. Call LLM for edge inference:
   ```typescript
   import { edgeInferencePrompt } from "@/lib/prompts";
   import { generateText } from "@/lib/minimax-native";
   import { parseLLMJson } from "@/lib/schemas";

   const prompt = edgeInferencePrompt(
     conceptName,
     existingConcepts.map(c => ({
       id: c.id,
       name: c.name,
       description: c.description ?? "",
     }))
   );

   const rawText = await generateText(
     [{ role: "user", content: `Connect "${conceptName}" to this knowledge graph.` }],
     prompt,
     { temperature: 0.2, maxTokens: 2048, model: "MiniMax-M2" }
   );
   ```
6. Parse LLM response (use `parseLLMJson` + manual validation — no Zod schema needed since we validate individually):
   - Validate each edge's `existingConceptId` exists in the graph (drop if not — per research pitfall #6).
   - Use `suggestedDifficultyTier` (clamp to 1-3), `suggestedDescription`, `suggestedKeyTerms`.
   - If LLM parse fails entirely, still create the node with no edges (graceful degradation).

7. Create the new concept via `findOrCreateConcept` (same pattern as `concepts/insert/route.ts`):
   - Use `suggestedDescription`, `suggestedKeyTerms`, proficiency 0.0, confidence 0.0.

8. Create GraphMembership with `depthTier` from LLM suggestion (clamped to [1, maxExistingTier + 1]).

9. Create edges — for each valid inferred edge:
   - If `direction === "prerequisite_of"`: create edge `existingConceptId -> newConceptId`
   - If `direction === "dependent_on"`: create edge `newConceptId -> existingConceptId`
   - After adding all inferred edges, run `validateDAG()` on the full graph.
   - If cycles detected: remove the most recently added edges (those from this request) that participate in cycles. Log which edges were dropped. Do NOT fail the request.

10. Compute force layout for the entire graph via `computeForceLayout`:
    ```typescript
    import { computeForceLayout } from "@/lib/algorithms/forceLayout";
    ```
    Build nodes array from all memberships (including new one), build links from all edges (including new ones).
    Persist positions via `prisma.$transaction`.

11. Return response:
    ```typescript
    return NextResponse.json({
      conceptId: newConceptId,
      membership: newMembership,
      edges: createdEdges,
      layout, // Record<string, {x, y}>
    });
    ```

12. **On-demand question generation** (per user decision): Do NOT fire-and-forget question generation here. Questions will be generated when the user first tries to practice this concept. This saves LLM calls for concepts the user may never practice.

**Error handling:** If LLM call fails (502, timeout), still create the concept with no edges. Return 200 with `edgeInferenceError: true` flag so the UI can optionally inform the user.

**2. Wire AddConceptFAB into `graph/page.tsx`:**

1. Import: `import { AddConceptFAB } from "@/components/graph/AddConceptFAB";`

2. Need the active study plan ID. Get it from the store:
   ```typescript
   const activeStudyPlanId = useAppStore((s) => s.activeStudyPlanId);
   ```

3. Create a callback to refresh graph data after concept addition:
   ```typescript
   const handleConceptAdded = useCallback(() => {
     if (activeUnitGraphId) {
       loadUnitGraphData(activeUnitGraphId);
     }
   }, [activeUnitGraphId, loadUnitGraphData]);
   ```

4. Render `AddConceptFAB` inside the graph canvas wrapper div (after ReactFlow, before the legend):
   ```tsx
   {activeStudyPlanId && activeUnitGraphId && (
     <AddConceptFAB
       studyPlanId={activeStudyPlanId}
       unitGraphId={activeUnitGraphId}
       onConceptAdded={handleConceptAdded}
     />
   )}
   ```
   Position it as an absolutely-positioned child inside the graph canvas wrapper.
  </action>
  <verify>
    <automated>cd adaptive-tutor && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Open graph tab, tap +, type "Linear Algebra", submit — verify new node appears in graph with inferred edges and graph reflows smoothly</manual>
  </verify>
  <done>add-custom endpoint creates concept, infers edges via LLM, validates DAG integrity, recomputes force layout. AddConceptFAB wired into graph page with refresh callback. Invalid edges silently dropped. On-demand question generation deferred to practice time.</done>
</task>

</tasks>

<verification>
1. `cd adaptive-tutor && npx tsc --noEmit` — zero TypeScript errors
2. Clicking + FAB opens form overlay, ESC closes it
3. Submitting concept name creates node in graph with LLM-inferred edges
4. Graph reflows after insertion (node position transition animation visible)
5. Invalid edge inferences (wrong concept IDs, cycles) are silently dropped
6. If LLM fails, concept still appears (just with no edges)
7. No questions generated until user actually practices the custom concept
</verification>

<success_criteria>
- User can add custom concepts to their knowledge graph from the graph view
- LLM infers meaningful edge connections (prerequisite/dependent relationships)
- Graph integrity maintained (DAG validation, no cycles)
- Force-directed layout recomputes and animates to accommodate new node
- On-demand question generation deferred to practice time (no wasteful LLM calls)
- Graceful degradation on LLM failure (concept created, no edges)
</success_criteria>

<output>
After completion, create `.planning/phases/09-web-style-force-directed-graph-layout-via-backend-positioning/09-03-SUMMARY.md`
</output>
