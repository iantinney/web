---
phase: 09-web-style-force-directed-graph-layout-via-backend-positioning
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - adaptive-tutor/src/components/graph/ParticleEdge.tsx
  - adaptive-tutor/src/components/graph/ConceptNode.tsx
  - adaptive-tutor/src/app/(tabs)/graph/page.tsx
autonomous: true
requirements:
  - LAYOUT-02
  - LAYOUT-03

must_haves:
  truths:
    - "Edges show animated particle streams flowing from prerequisite to dependent"
    - "Particle density and speed scale with source node proficiency"
    - "Locked edges appear dim and dashed with zero particles"
    - "Edges arrive at nodes from any direction (not just top/bottom)"
    - "Node positions animate smoothly when layout changes"
  artifacts:
    - path: "adaptive-tutor/src/components/graph/ParticleEdge.tsx"
      provides: "Custom React Flow edge with organic bezier spline and SVG animateMotion particles"
      exports: ["ParticleEdge"]
    - path: "adaptive-tutor/src/components/graph/ConceptNode.tsx"
      provides: "Multi-directional handles (4 sides) replacing Top/Bottom only"
      exports: ["ConceptNode", "nodeTypes"]
    - path: "adaptive-tutor/src/app/(tabs)/graph/page.tsx"
      provides: "Wired ParticleEdge as custom edge type, proficiency-driven edge data, node transition animation"
  key_links:
    - from: "adaptive-tutor/src/app/(tabs)/graph/page.tsx"
      to: "adaptive-tutor/src/components/graph/ParticleEdge.tsx"
      via: "edgeTypes registration and flowEdges data with sourceProficiency/isLocked"
      pattern: "edgeTypes.*particle.*ParticleEdge"
    - from: "adaptive-tutor/src/components/graph/ConceptNode.tsx"
      to: "@xyflow/react"
      via: "Handle components on all 4 positions"
      pattern: "Handle.*Position\\.(Top|Bottom|Left|Right)"
---

<objective>
Create the ParticleEdge custom edge component with organic bezier splines and animated particle streams, update ConceptNode to multi-directional handles, and wire everything into the graph page.

Purpose: Transform the graph from a static flowchart into a living neural network where direction is communicated through particle flow (prerequisite to dependent), intensity reflects mastery level, and edges can approach from any direction since the layout is no longer hierarchical.

Output: `ParticleEdge.tsx` component, updated `ConceptNode.tsx` with 4-directional handles, updated `graph/page.tsx` with custom edge type registration and proficiency-driven edge data. Use the frontend-design skill for all visual/animation implementation per user decision.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-web-style-force-directed-graph-layout-via-backend-positioning/09-RESEARCH.md
@adaptive-tutor/src/components/graph/ConceptNode.tsx
@adaptive-tutor/src/app/(tabs)/graph/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ParticleEdge custom edge component</name>
  <files>
    adaptive-tutor/src/components/graph/ParticleEdge.tsx
  </files>
  <action>
Create `adaptive-tutor/src/components/graph/ParticleEdge.tsx` — a React Flow custom edge component.

**Use the frontend-design skill for all visual/animation choices** per user decision. The edge must feel biological — axon-like connections with signal pulses traveling along them.

**Component interface:**
```typescript
interface ParticleEdgeData {
  sourceProficiency: number;  // 0.0-1.0
  isLocked: boolean;
}
```

Receives standard React Flow `EdgeProps<ParticleEdgeData>`.

**Organic spline path** (per user decision "organic splines"):
- Use `getBezierPath` from `@xyflow/react` with `curvature: 0.4` for organic feel (per research recommendation).
- Higher curvature makes paths less rigid and more biological.

**Locked edge treatment** (per user decision "dim + dashed, no particles"):
- Render a single `<path>` with `stroke: rgba(74, 74, 100, 0.15)`, `strokeWidth: 1`, `strokeDasharray: "4 6"`.
- Zero particle elements. Communicates "not yet accessible."
- Return early — skip all particle logic.

**Active edge rendering:**
- Base edge: Use `<BaseEdge>` from `@xyflow/react` with the bezier path. Stroke color derives from the project's existing palette — use the green accent `rgba(0, 210, 160, opacity)` where opacity = `0.15 + proficiency * 0.35` (dim at 0%, moderately visible at 100%).
- strokeWidth: 1.5

**Particle stream** (per user decision "multiple tiny particles flowing from prerequisite to dependent"):
- Particle count scales with proficiency: `Math.max(1, Math.round(proficiency * 5))` — 1 particle at 0%, 5 at 100%.
- Duration scales with proficiency (faster = more mastered): `4 - proficiency * 2.5` seconds — 4s at 0%, 1.5s at 100%.
- Each particle is a `<circle r={2}>` with `<animateMotion>`:
  - `dur`: the computed duration
  - `repeatCount`: "indefinite"
  - `path`: the bezier edge path string
  - `begin`: stagger by `(i / particleCount) * duration` seconds so particles are evenly distributed along the path.
- Particle fill: `rgba(0, 210, 160, opacity)` where opacity = `0.3 + proficiency * 0.5`.
- Add a subtle glow using a second slightly larger `<circle r={4}>` with lower opacity behind each particle for the "neural pulse" effect.

**Performance note** (from research pitfall #4): SVG `<animateMotion>` is browser-native and GPU-accelerated — no JS per-frame overhead. For typical graphs (8-30 nodes, up to ~50 edges), this is fine. Do NOT use stroke-dasharray animation.

**Export:** Named export `ParticleEdge` function component. Also export `edgeTypes` object: `{ particle: ParticleEdge }` for graph page registration.
  </action>
  <verify>
    <automated>cd adaptive-tutor && npx tsc --noEmit 2>&1 | grep -c "error" || echo "0 errors"</automated>
    <manual>Open graph tab — edges should show particle streams moving from prerequisite toward dependent, with density/speed varying by source proficiency</manual>
  </verify>
  <done>ParticleEdge renders organic bezier path with proficiency-driven particle streams. Locked edges render dim/dashed with no particles. Component exports cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Update ConceptNode handles and wire ParticleEdge into graph page</name>
  <files>
    adaptive-tutor/src/components/graph/ConceptNode.tsx
    adaptive-tutor/src/app/(tabs)/graph/page.tsx
  </files>
  <action>
**ConceptNode.tsx — Multi-directional handles** (per research pitfall #3):

The current component has:
- `<Handle type="target" position={Position.Top} style={handleStyle} />` (line 108)
- `<Handle type="source" position={Position.Bottom} style={handleStyle} />` (line 260)

This causes ugly edge snapping with force-directed layout. Replace with handles on all four sides:

```typescript
// Hidden handle style — visually clean but functionally present
const hiddenHandleStyle = {
  background: "transparent",
  border: "none",
  width: 6,
  height: 6,
  opacity: 0,
};
```

Replace the single target Handle with:
```typescript
<Handle type="target" position={Position.Top} id="target-top" style={hiddenHandleStyle} />
<Handle type="target" position={Position.Left} id="target-left" style={hiddenHandleStyle} />
```

Replace the single source Handle with:
```typescript
<Handle type="source" position={Position.Bottom} id="source-bottom" style={hiddenHandleStyle} />
<Handle type="source" position={Position.Right} id="source-right" style={hiddenHandleStyle} />
```

React Flow automatically picks the closest handle pair for each edge — this enables multi-directional edges for force-directed layout.

**graph/page.tsx — Wire ParticleEdge + proficiency-driven edge data:**

1. Import: `import { edgeTypes } from "@/components/graph/ParticleEdge";`

2. Rewrite the `flowEdges` useMemo to pass proficiency data to ParticleEdge:
   ```typescript
   const flowEdges: Edge[] = useMemo(() =>
     graphEdges.map((edge) => {
       const sourceConcept = graphConcepts.find(c => c.id === edge.fromNodeId);
       const sourceProficiency = sourceConcept?.proficiency ?? 0;
       const targetLocked = lockedConceptIds.has(edge.toNodeId);

       return {
         id: edge.id,
         source: edge.fromNodeId,
         target: edge.toNodeId,
         type: "particle",  // Custom edge type
         data: {
           sourceProficiency,
           isLocked: targetLocked,
         },
       };
     }),
     [graphEdges, graphConcepts, lockedConceptIds]
   );
   ```
   Remove the old `edgeStrokeMap` constant at the top (no longer needed — ParticleEdge handles all styling internally).
   Remove the old `animated` flag logic and `smoothstep` type.

3. Pass `edgeTypes` to ReactFlow component:
   ```typescript
   <ReactFlow
     nodes={nodes}
     edges={edges}
     onNodesChange={onNodesChange}
     onEdgesChange={onEdgesChange}
     nodeTypes={nodeTypes}
     edgeTypes={edgeTypes}     // <-- ADD THIS
     ...
   />
   ```

4. Add node position CSS transition for smooth movement when layout recomputes (per research recommendation):
   In the `flowNodes` useMemo, add a style property:
   ```typescript
   style: {
     transition: "transform 0.8s cubic-bezier(0.16, 1, 0.3, 1)",
   },
   ```
   This makes nodes glide smoothly to new positions when the layout recomputes after node insertion.

5. Update hover focus logic: the `connectedIds` effect that dims unrelated edges currently spreads `edge.style`. Since ParticleEdge handles its own rendering, set opacity on the edge wrapper via the `style` property instead:
   ```typescript
   setEdges(
     flowEdges.map((edge) => ({
       ...edge,
       style: {
         opacity: connectedIds.has(edge.source) && connectedIds.has(edge.target) ? 1 : 0.06,
         transition: "opacity 0.3s ease",
       },
     }))
   );
   ```

6. Remove the import of `proficiencyColor` from `@/lib/utils` if no longer used in this file (check — it was used for edge color which is now in ParticleEdge). Keep it if still used for other purposes.
  </action>
  <verify>
    <automated>cd adaptive-tutor && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Open graph tab — verify edges render with particle animation, nodes accept edges from all directions, hover focus dims unrelated edges correctly</manual>
  </verify>
  <done>ConceptNode has 4-directional handles. Graph page uses ParticleEdge custom edge type with proficiency-driven particle data. Node positions have smooth CSS transition. Hover focus works with new edge system.</done>
</task>

</tasks>

<verification>
1. `cd adaptive-tutor && npx tsc --noEmit` — zero TypeScript errors
2. Visual: Graph edges show animated particles flowing prerequisite -> dependent
3. Visual: Mastered (green) source nodes produce 5 fast particles; untested (gray) produce 1 slow particle
4. Visual: Locked edges are dim dashed lines with no particles
5. Visual: Edges approach nodes from multiple directions (not just top/bottom)
6. Visual: Node hover dims unrelated edges and nodes correctly
</verification>

<success_criteria>
- ParticleEdge replaces smoothstep edges with organic bezier + particle streams
- Direction communicated through particle flow, not arrowheads
- Proficiency drives particle count, speed, and brightness
- Multi-directional handles support force-directed layout
- Node position transitions are smooth (0.8s ease)
- No regression in node click, hover focus, or detail panel
</success_criteria>

<output>
After completion, create `.planning/phases/09-web-style-force-directed-graph-layout-via-backend-positioning/09-02-SUMMARY.md`
</output>
